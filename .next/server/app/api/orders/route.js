"use strict";(()=>{var e={};e.id=9146,e.ids=[9146],e.modules={98860:e=>{e.exports=require("jsdom")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},37358:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>v,requestAsyncStorage:()=>C,routeModule:()=>E,serverHooks:()=>P,staticGenerationAsyncStorage:()=>I});var n={};r.r(n),r.d(n,{DELETE:()=>N,GET:()=>g,PATCH:()=>w,POST:()=>y});var a=r(49303),o=r(88716),i=r(60670),s=r(87070),u=r(50650),l=r(83493),c=r(97453),p=r(75498),d=r(7410);let m={};function f(e){e?Object.keys(m).forEach(t=>{t.includes(e)&&delete m[t]}):Object.keys(m).forEach(e=>delete m[e])}let h=d.z.object({firstName:d.z.string(),middleName:d.z.string().optional(),lastName:d.z.string(),dateOfBirth:d.z.string().or(d.z.date()),sex:d.z.string(),eyeColor:d.z.string(),hairColor:d.z.string(),height:d.z.string().regex(/^[4-6]'(?:10|11|[0-9])"$/,"Invalid height format"),weight:d.z.number().min(50).max(500),state:d.z.string(),platform:d.z.enum(["Snapchat","Telegram"]),username:d.z.string(),paymentMethod:d.z.string(),wantEReceipt:d.z.boolean(),email:d.z.preprocess(e=>null==e||""===e?void 0:e,d.z.string().email().optional()),passportPhotoBase64:d.z.string().optional(),signaturePhotoBase64:d.z.string().optional(),price:d.z.number().optional(),originalPrice:d.z.number().optional(),couponId:d.z.string().optional()}).refine(e=>!e.wantEReceipt||!!e.email,{message:"Email is required when e-receipt is enabled",path:["email"]});async function g(e){try{let t=new URL(e.url),r=function(e){let t=e.pathname,r=e.searchParams.toString();return`${t}?${r}`}(t),n=function(e){let t=m[e],r=Date.now();return t&&r<t.expiry?t.data:(t&&delete m[e],null)}(r);if(n)return s.NextResponse.json(n);let a=t.searchParams.get("ids")?.split(","),o=parseInt(t.searchParams.get("page")||"1"),i=parseInt(t.searchParams.get("limit")||"50"),u=(o-1)*i,p=t.searchParams.get("status"),d=t.searchParams.get("search"),f="true"===t.searchParams.get("includeCoupons"),h=!d&&(o>1||"all"!==p),g=a?.map(e=>c.Vx(e)).filter(e=>null!==e),y={};g&&g.length>0&&(y.id={in:g}),p&&"all"!==p&&(y.status=p),d&&(y.OR=[{firstName:{contains:d,mode:"insensitive"}},{lastName:{contains:d,mode:"insensitive"}},{orderNumber:{contains:d,mode:"insensitive"}},{username:{contains:d,mode:"insensitive"}}]);let w=await l._.order.count({where:y}),N=await l._.order.findMany({where:y,select:{id:!0,orderNumber:!0,createdAt:!0,firstName:!0,lastName:!0,state:!0,platform:!0,username:!0,paymentMethod:!0,status:!0,hasPaid:!0,price:!0,originalPrice:!0,couponId:!!f,middleName:!!d,dateOfBirth:!1,sex:!1,eyeColor:!1,hairColor:!1,height:!1,weight:!1,email:!1,wantEReceipt:!1,passportPhotoUrl:!0,signaturePhotoUrl:!0},orderBy:{createdAt:"desc"},skip:u,take:i}),E=N;if(f&&N.length>0){let e=N.map(e=>e.couponId).filter(e=>null!=e);if(e.length>0){let t=await l._.coupon.findMany({where:{id:{in:e}},select:{id:!0,code:!0,discountType:!0,discountValue:!0}}),r=new Map(t.map(e=>[e.id,e]));E=N.map(e=>e.couponId&&r.has(e.couponId)?{...e,coupon:r.get(e.couponId)}:e)}}let C=await l._.paymentMethod.findMany({select:{name:!0,paymentInstructions:!0}}),I=new Map(C.map(e=>[e.name,e.paymentInstructions])),P=E.map(e=>({...e,paymentInstructions:I.get(e.paymentMethod)||""})),x={success:!0,orders:P,pagination:{total:w,page:o,limit:i,totalPages:Math.ceil(w/i)}};return function(e,t,r=!1){if(m[e]={data:t,expiry:Date.now()+(r?3e5:6e4)},Object.keys(m).length>100){let e=Object.entries(m);e.sort((e,t)=>e[1].expiry-t[1].expiry);let t=Math.ceil(20);for(let r=0;r<t&&r<e.length;r++)delete m[e[r][0]]}}(r,x,h),s.NextResponse.json(x,{headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}})}catch(e){return console.error("Error fetching orders:",e),s.NextResponse.json({success:!1,message:"Error fetching orders",error:e instanceof Error?e.message:"Unknown error"},{status:500,headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}})}}async function y(e){f();try{let t=await e.json();if(!Array.isArray(t))return s.NextResponse.json({success:!1,error:"Invalid request format. Expected an array of orders."},{status:400});let r=await l._.priceConfig.findFirst({orderBy:{createdAt:"desc"}});if(!r)return s.NextResponse.json({success:!1,error:"Price configuration not found"},{status:500});let n=await l._.$transaction(async e=>await Promise.all(t.map(async t=>{let n=h.parse(t),a=r.amount;if(n.couponId){let t=await e.coupon.findUnique({where:{id:n.couponId}});if(!t)throw Error("Invalid coupon");"PERCENTAGE"===t.discountType?a=(0,u._)(r.amount*(1-t.discountValue/100)):"FIXED_AMOUNT"===t.discountType?a=(0,u._)(Math.max(0,r.amount-t.discountValue)):"FIXED_PRICE"===t.discountType&&(a=(0,u._)(t.discountValue)),await e.coupon.update({where:{id:n.couponId},data:{usageCount:{increment:1}}})}let o=null,i=null;return n.passportPhotoBase64&&(0,p.h)(n.passportPhotoBase64)&&(o=await (0,p.l)(n.passportPhotoBase64)),n.signaturePhotoBase64&&(0,p.h)(n.signaturePhotoBase64)&&(i=await (0,p.l)(n.signaturePhotoBase64)),await e.order.create({data:{firstName:(0,c.vJ)(n.firstName),middleName:n.middleName?(0,c.vJ)(n.middleName):null,lastName:(0,c.vJ)(n.lastName),dateOfBirth:(0,c.DA)(n.dateOfBirth),sex:(0,c.vJ)(n.sex),eyeColor:(0,c.vJ)(n.eyeColor),hairColor:(0,c.vJ)(n.hairColor),height:(0,c.Rz)(n.height),weight:(0,c.Uw)(n.weight),state:(0,c.EY)(n.state),platform:(0,c.yf)(n.platform),username:(0,c.oc)(n.username),paymentMethod:(0,c.eB)(n.paymentMethod),wantEReceipt:(0,c.e7)(n.wantEReceipt),email:n.email?(0,c.H3)(n.email):null,passportPhotoUrl:o,signaturePhotoUrl:i,orderNumber:(0,u.m)(),status:"RECEIVED",price:a,originalPrice:r.amount,...n.couponId?{coupon:{connect:{id:n.couponId}}}:{}},include:{coupon:{select:{code:!0,discountType:!0,discountValue:!0,usageLimit:!0,usageCount:!0}}}})})));return s.NextResponse.json({success:!0,orders:n})}catch(e){return console.error("Error creating orders:",e),s.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to create orders"},{status:500})}}async function w(e){f()}async function N(e){f()}let E=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:"app/api/orders/route"},resolvedPagePath:"/Users/kyleaditya/Documents/IDF coupon fulldetails/app/api/orders/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:C,staticGenerationAsyncStorage:I,serverHooks:P}=E,x="/api/orders/route";function v(){return(0,i.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:I})}},75498:(e,t,r)=>{r.d(t,{l:()=>o,h:()=>i});let n=require("sharp");var a=r.n(n);async function o(e,t=80){try{let r=e.split(";base64,").pop();if(!r)throw Error("Invalid base64 string");let n=Buffer.from(r,"base64"),o=(await a()(n).webp({quality:t}).toBuffer()).toString("base64");return`data:image/webp;base64,${o}`}catch(t){return console.error("Error converting image to WebP:",t),e}}function i(e){if(!e||"string"!=typeof e)return!1;try{if(!e.startsWith("data:image/"))return!1;let[t,r]=e.split(",");if(!t||!r)return!1;return atob(r),!0}catch{return!1}}},83493:(e,t,r)=>{r.d(t,{_:()=>a});let n=require("@prisma/client"),a=globalThis.prisma??new n.PrismaClient},97453:(e,t,r)=>{r.d(t,{Cd:()=>p,DA:()=>d,EY:()=>h,Gi:()=>g,H3:()=>u,Rz:()=>I,Uw:()=>P,Vx:()=>f,Wx:()=>E,Yn:()=>N,Z6:()=>C,dB:()=>w,e7:()=>m,eB:()=>y,oc:()=>l,vJ:()=>s,yf:()=>c});var n=r(96468),a=r.n(n),o=r(61555),i=r.n(o);function s(e){return"string"!=typeof e?"":i().escape(e.trim())}function u(e){return"string"!=typeof e?"":i().normalizeEmail(e.trim().toLowerCase())||""}function l(e){return"string"!=typeof e?"":i().escape(e.trim()).replace(/[^a-zA-Z0-9_.-]/g,"")}function c(e){if("string"!=typeof e)return null;let t=e.trim();return"snapchat"===t.toLowerCase()?"Snapchat":"telegram"===t.toLowerCase()?"Telegram":null}function p(e){if("number"==typeof e)return e>0?Math.round(100*e)/100:null;if("string"==typeof e){let t=parseFloat(e);return!isNaN(t)&&t>0?Math.round(100*t)/100:null}return null}function d(e){if(e instanceof Date)return e;if("string"==typeof e){let t=new Date(e);return isNaN(t.getTime())?null:t}return null}function m(e){if("boolean"==typeof e)return e;if("string"==typeof e){let t=e.toLowerCase();return"true"===t||"1"===t||"yes"===t}return"number"==typeof e&&1===e}function f(e){if("string"!=typeof e)return null;let t=e.trim();return/^c[a-z0-9]{24}$/.test(t)?t:null}function h(e){if("string"!=typeof e)return null;let t=e.trim();return["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"].includes(t)?t:null}function g(e){if("string"!=typeof e)return null;let t=e.trim().toUpperCase();return["RECEIVED","PROCESSING","IN_PRODUCTION","IN_TRANSIT","DELIVERED","CANCELLED"].includes(t)?t:null}function y(e){return"string"!=typeof e?null:e.trim()||null}function w(e){if("string"!=typeof e)return null;let t=e.trim();if(!t.startsWith("data:image/"))return null;let[r,n]=t.split(",");if(!r||!n)return null;try{return atob(n),t}catch{return null}}function N(e){if("string"!=typeof e)return null;let t=e.trim().toUpperCase();return["ADMIN","USER"].includes(t)?t:null}function E(e){if("string"!=typeof e)return null;let t=e.trim().toUpperCase();return["INFO","FAQ","PRIVACY"].includes(t)?t:null}function C(e){return"string"!=typeof e?"":a().sanitize(e.trim())}function I(e){if("string"!=typeof e)return null;let t=e.trim();return/^[4-6]'(?:10|11|[0-9])"$/.test(t)?t:null}function P(e){if("number"==typeof e)return e>=50&&e<=500?Math.round(e):null;if("string"==typeof e){let t=parseInt(e,10);return!isNaN(t)&&t>=50&&t<=500?t:null}return null}},50650:(e,t,r)=>{function n(){let e=Date.now().toString(),t=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return`KID${e}${t}`}function a(e){return Math.round(100*e)/100}r.d(t,{_:()=>a,m:()=>n})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,3556,7410],()=>r(37358));module.exports=n})();